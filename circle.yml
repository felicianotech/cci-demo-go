machine:
  environment:
    TEST_RESULTS: "/tmp/test-results"
    CONTACTS_DB_URL: "postgres://root@localhost:5432/circle_test?sslmode=disable"
    CONTACTS_DB_MIGRATIONS: "/home/ubuntu/.go_workspace/src/github.com/felicianotech/cci-demo-go/db/migrations"
  post:
    - ls -lah ~/.go_workspace/

dependencies:
  override:
    - mkdir $CIRCLE_TEST_REPORTS/reports
    - go get github.com/jstemmer/go-junit-report

test:
  override:
    - trap "go-junit-report <${CIRCLE_TEST_REPORTS}/reports/go-test.out > ${CIRCLE_TEST_REPORTS}/reports/go-test-report.xml" EXIT
    - cd ~/.go_workspace/src/github.com/felicianotech/cci-demo-go && make test | tee ${CIRCLE_TEST_REPORTS}/reports/go-test.out
    - cd ~/.go_workspace/src/github.com/felicianotech/cci-demo-go && make
    - ~/.go_workspace/src/github.com/felicianotech/cci-demo-go/workdir/contacts:
        background: true
    - |
      sleep 5
      curl --retry 10 --retry-delay 1 -X POST --header "Content-Type: application/json" -d '{"email":"test@example.com","name":"Test User"}' http://localhost:8080/contacts
  post:
    - echo "end"
